# Ubuntu Nginx サイト設定ファイル
# 配置場所: /etc/nginx/sites-available/my-portfolio
# 用途: 既存の my-portfolio 設定に Bullet Hell を追加
# 操作:
#   sudo cp nginx-site-config.conf /etc/nginx/sites-available/my-portfolio
#   sudo systemctl reload nginx

# 既存の Node.js アプリ + Bullet Hell（同じドメイン）
server {
    server_name kouya.st.ie.u-ryukyu.ac.jp;

    # 既存の Node.js ポートフォリオアプリ
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # Bullet Hell API（Docker Nginx経由でバックエンドへ）- 先に定義
    location ^~ /bullet-hell/api/ {
        rewrite ^/bullet-hell/api/(.*)$ /api/$1 break;
        proxy_pass http://localhost:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # Bullet Hell フロントエンド
    location /bullet-hell/ {
        proxy_pass http://localhost:8000/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    listen 443 ssl http2; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/kouya.st.ie.u-ryukyu.ac.jp/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/kouya.st.ie.u-ryukyu.ac.jp/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

server {
    listen 80;
    server_name kouya.st.ie.u-ryukyu.ac.jp;
    
    # Bullet Hell API（HTTP用）
    location ^~ /bullet-hell/api/ {
        rewrite ^/bullet-hell/api/(.*)$ /api/$1 break;
        proxy_pass http://localhost:8000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # Bullet Hell フロントエンド（HTTP用）
    location /bullet-hell/ {
        proxy_pass http://localhost:8000/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # 既存の Node.js アプリ
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # その他はHTTPSにリダイレクト（localhost以外）
    if ($host = kouya.st.ie.u-ryukyu.ac.jp) {
        return 301 https://$host$request_uri;
    }
}
